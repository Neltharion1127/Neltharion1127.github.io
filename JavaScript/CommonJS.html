<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CommonJS | Hello, World.</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="📦 🎨 A api-friendly theme for VuePress.">
    
    <link rel="preload" href="/assets/css/0.styles.3cb8d2af.css" as="style"><link rel="preload" href="/assets/js/app.a138196f.js" as="script"><link rel="preload" href="/assets/js/3.41a850e3.js" as="script"><link rel="preload" href="/assets/js/8.8035cd59.js" as="script"><link rel="prefetch" href="/assets/js/1.134260ed.js"><link rel="prefetch" href="/assets/js/10.50679057.js"><link rel="prefetch" href="/assets/js/11.ed1e6b44.js"><link rel="prefetch" href="/assets/js/12.bc30df44.js"><link rel="prefetch" href="/assets/js/13.87fa51bf.js"><link rel="prefetch" href="/assets/js/14.c788a1df.js"><link rel="prefetch" href="/assets/js/15.ca69aec6.js"><link rel="prefetch" href="/assets/js/16.897362a8.js"><link rel="prefetch" href="/assets/js/17.88d9cfbe.js"><link rel="prefetch" href="/assets/js/18.7c60a920.js"><link rel="prefetch" href="/assets/js/19.b750c8b8.js"><link rel="prefetch" href="/assets/js/20.e04610fc.js"><link rel="prefetch" href="/assets/js/4.287a8ba3.js"><link rel="prefetch" href="/assets/js/5.d105af4a.js"><link rel="prefetch" href="/assets/js/6.a6d9a3c7.js"><link rel="prefetch" href="/assets/js/7.7fbe2fb6.js"><link rel="prefetch" href="/assets/js/9.8a2b1b86.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3cb8d2af.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme__container"><div class="row"><div class="col-md-3 col-lg-2 sidebar__container"><div class="menu menu__container"><div class="menu__box"><a class="menu__btn"><div class="hamburger"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></a></div></div> <div class="sidebar" style="width:100%;display:none;"><div class="group"><div class="group__title">Search</div> <div class="group__body"><div class="search search__container"><div class="search__heading"><input type="text" value="" class="search__ipt"></div> <div class="search__body"><ul class="search__list" style="display:none;"><li class="search__item"><a href="/" class="router-link-active">Hello, World.</a></li><li class="search__item"><a href="/Design%20Pattern/Dependency%20Injection.html">依赖注入（Dependecy Injection）</a></li><li class="search__item"><a href="/Design%20Pattern/Dependency%20Injection.html#依赖注入的概念了解">依赖注入的概念了解</a></li><li class="search__item"><a href="/Design%20Pattern/Dependency%20Injection.html#依赖注入的优点、实现">依赖注入的优点、实现</a></li><li class="search__item"><a href="/Design%20Pattern/Dependency%20Injection.html#小结">小结</a></li></ul></div></div></div></div> <!----> <div class="group"><div class="group__title">
      home
    </div> <div class="group__body"><div class="group__category category"><div class="category__label"><a href="/" class="category__link sidebar-link router-link-active">Hello, World.</a></div></div> <!----> <!----></div></div><div class="group"><div class="group__title">
      Design Pattern
    </div> <div class="group__body"><!----> <!----> <div><div class="group__category category"><div class="category__label"><a href="/Design%20Pattern/Dependency%20Injection.html" class="category__link sidebar-link">依赖注入（Dependecy Injection）</a></div> <div><div class="category__headers"><div class="category__header-item"><a href="/Design%20Pattern/Dependency%20Injection.html#依赖注入的概念了解" class="category__link sidebar-link">依赖注入的概念了解</a></div></div><div class="category__headers"><div class="category__header-item"><a href="/Design%20Pattern/Dependency%20Injection.html#依赖注入的优点、实现" class="category__link sidebar-link">依赖注入的优点、实现</a></div></div><div class="category__headers"><div class="category__header-item"><a href="/Design%20Pattern/Dependency%20Injection.html#小结" class="category__link sidebar-link">小结</a></div></div></div></div></div></div></div><div class="group"><div class="group__title">
      JavaScript
    </div> <div class="group__body"><!----> <!----> <div><div class="group__category category"><div class="category__label"><a href="/JavaScript/async%20function.html" class="category__link sidebar-link">Async函数</a></div> <!----></div><div class="group__category category"><div class="category__label"><a href="/JavaScript/OAuth%202%20code(authorization%20code).html" class="category__link sidebar-link">Oauth 2 Code实现单点登录(Authorization Code)</a></div> <div><div class="category__headers"><div class="category__header-item"><a href="/JavaScript/OAuth%202%20code(authorization%20code).html#_1-oauth2-单点的登录的实现逻辑-白话版" class="category__link sidebar-link">1.Oauth2 单点的登录的实现逻辑（白话版）</a></div></div><div class="category__headers"><div class="category__header-item"><a href="/JavaScript/OAuth%202%20code(authorization%20code).html#_2-具体代码-vue-router-guard" class="category__link sidebar-link">2.具体代码(Vue Router Guard)</a></div></div></div></div><div class="group__category category category--selected category--active"><div class="category__label"><a href="/JavaScript/CommonJS.html" aria-current="page" class="category__link sidebar-link router-link-exact-active router-link-active">Commonjs</a></div> <div><div class="category__headers"><div class="category__header-item"><a href="/JavaScript/CommonJS.html#_1-概述" class="category__link sidebar-link">1.概述</a></div></div><div class="category__headers"><div class="category__header-item"><a href="/JavaScript/CommonJS.html#_2-module对象" class="category__link sidebar-link">2.Module对象</a></div></div><div class="category__headers"><div class="category__header-item"><a href="/JavaScript/CommonJS.html#_3-amd规范和commonjs规范的兼容性" class="category__link sidebar-link">3.Amd规范和Commonjs规范的兼容性</a></div></div><div class="category__headers"><div class="category__header-item"><a href="/JavaScript/CommonJS.html#_4-require命令" class="category__link sidebar-link">4.Require命令</a></div></div><div class="category__headers"><div class="category__header-item"><a href="/JavaScript/CommonJS.html#_5-模块的加载机制" class="category__link sidebar-link">5.模块的加载机制</a></div></div></div></div><div class="group__category category"><div class="category__label"><a href="/JavaScript/promise.html" class="category__link sidebar-link">Promise</a></div> <!----></div><div class="group__category category"><div class="category__label"><a href="/JavaScript/class.html" class="category__link sidebar-link">类构造函数</a></div> <div><div class="category__headers"><div class="category__header-item"><a href="/JavaScript/class.html#_1-实例化" class="category__link sidebar-link">1. 实例化</a></div></div><div class="category__headers"><div class="category__header-item"><a href="/JavaScript/class.html#_2-把类当成普通函数" class="category__link sidebar-link">2. 把类当成普通函数</a></div></div></div></div><div class="group__category category"><div class="category__label"><a href="/JavaScript/prototype.html" class="category__link sidebar-link">对象和原型</a></div> <!----></div><div class="group__category category"><div class="category__label"><a href="/JavaScript/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAnew.html" class="category__link sidebar-link">实现一个New</a></div> <!----></div><div class="group__category category"><div class="category__label"><a href="/JavaScript/prototypeChain.html" class="category__link sidebar-link">原型链</a></div> <!----></div><div class="group__category category"><div class="category__label"><a href="/JavaScript/%E7%BB%84%E5%90%88%E5%AF%84%E7%94%9F%E7%BB%A7%E6%89%BF.html" class="category__link sidebar-link">组合寄生继承</a></div> <!----></div><div class="group__category category"><div class="category__label"><a href="/JavaScript/%E9%98%B2%E6%8A%96%20%E8%8A%82%E6%B5%81.html" class="category__link sidebar-link">防抖 节流</a></div> <div><div class="category__headers"><div class="category__header-item"><a href="/JavaScript/%E9%98%B2%E6%8A%96%20%E8%8A%82%E6%B5%81.html#函数防抖" class="category__link sidebar-link">函数防抖</a></div></div><div class="category__headers"><div class="category__header-item"><a href="/JavaScript/%E9%98%B2%E6%8A%96%20%E8%8A%82%E6%B5%81.html#函数节流" class="category__link sidebar-link">函数节流</a></div></div></div></div></div></div></div><div class="group"><div class="group__title">
      Network
    </div> <div class="group__body"><!----> <!----> <div><div class="group__category category"><div class="category__label"><a href="/Network/%E8%BE%93%E5%85%A5%E4%B8%80%E4%B8%AAURL%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.html" class="category__link sidebar-link">输入一个Url发生了什么</a></div> <div><div class="category__headers"><div class="category__header-item"><a href="/Network/%E8%BE%93%E5%85%A5%E4%B8%80%E4%B8%AAURL%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.html#_1-有缓存" class="category__link sidebar-link">1.有缓存</a></div></div><div class="category__headers"><div class="category__header-item"><a href="/Network/%E8%BE%93%E5%85%A5%E4%B8%80%E4%B8%AAURL%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.html#_2-浏览器查找域名的ip地址" class="category__link sidebar-link">2.浏览器查找域名的Ip地址</a></div></div><div class="category__headers"><div class="category__header-item"><a href="/Network/%E8%BE%93%E5%85%A5%E4%B8%80%E4%B8%AAURL%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88.html#_3-浏览器向web服务器发送一个http请求" class="category__link sidebar-link">3.浏览器向Web服务器发送一个HTTP请求</a></div></div></div></div></div></div></div><div class="group"><div class="group__title">
      Other
    </div> <div class="group__body"><!----> <!----> <div><div class="group__category category"><div class="category__label"><a href="/Other/WSL2.html" class="category__link sidebar-link">记录一次Wsl2搭建前端开发环境的过程</a></div> <div><div class="category__headers"><div class="category__header-item"><a href="/Other/WSL2.html#_1-安装wsl" class="category__link sidebar-link">1. 安装Wsl</a></div></div><div class="category__headers"><div class="category__header-item"><a href="/Other/WSL2.html#_2-修改软件源" class="category__link sidebar-link">2. 修改软件源</a></div></div><div class="category__headers"><div class="category__header-item"><a href="/Other/WSL2.html#_2-安装nodejs" class="category__link sidebar-link">2. 安装Nodejs</a></div></div><div class="category__headers"><div class="category__header-item"><a href="/Other/WSL2.html#_3-windows环境" class="category__link sidebar-link">3. Windows环境</a></div></div></div></div><div class="group__category category"><div class="category__label"><a href="/Other/Github%20fork.html" class="category__link sidebar-link">Github Fork</a></div> <!----></div></div></div></div></div></div> <div class="col-md-9 col-lg-10 content__container"><div class="page__container"><div custom="" class="content__default"><h1 id="commonjs"><a href="#commonjs" class="header-anchor">#</a> CommonJS</h1> <h2 id="_1-概述"><a href="#_1-概述" class="header-anchor">#</a> 1.概述</h2> <p>node应用由模块组成，有自己的作用域。在一个文件里定义的变量、函数、类都是私有的，对其他的文件都不可见。</p> <p>CommonJS规定，每个模块内部，<code>module</code>变量代表当前模块。这个变量是一个对象，他的exports属性（即module.export）是对外的接口。加载某个模块，其实是加载该模块的module.exports属性。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">5</span>
<span class="token keyword">var</span> <span class="token function-variable function">addX</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> value <span class="token operator">+</span>x
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>x <span class="token operator">=</span> x
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>addX <span class="token operator">=</span> addX
</code></pre></div><p><code>require</code>方法用于加载模块</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> example <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./example.js'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>example<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>example<span class="token punctuation">.</span><span class="token function">addX</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>CommonJS模块的特点如下：</p> <ul><li>所有的代码都运行在模块作用域，不会污染全局作用域。</li> <li>代码可以多次加载，但是只会在第一次加载时运行一次，然后运行结果就被缓存了，以后再加载，就直接读取缓存结果。要想让模块再次运行，必须清除缓存。</li> <li>模块加载的顺序，按照其在代码种出现的顺序。</li></ul> <h2 id="_2-module对象"><a href="#_2-module对象" class="header-anchor">#</a> 2.module对象</h2> <p>node内部提供一个<code>module</code>构建函数。所有模块都是<code>module</code>的实例。</p> <p>每个模块内部，都有一个<code>module</code>对象，代表当前模块。</p> <ul><li><code>module.id</code> 模块的识别符，通常是带有绝对路径的模块文件名。</li> <li><code>module.filename</code> 模块的文件名，带有绝对路径。</li> <li><code>module.loaded</code> 返回一个布尔值，表示模块是否已经完成加载。</li> <li><code>module.parent</code> 返回一个对象，表示调用该模块的模块。</li> <li><code>module.children</code> 返回一个数组，表示该模块要用到的其他模块。</li> <li><code>module.exports</code> 表示模块对外输出的值。</li></ul> <h3 id="_2-1-module-exports属性"><a href="#_2-1-module-exports属性" class="header-anchor">#</a> 2.1 module.exports属性</h3> <p><code>module.export</code>属性表示当前模块对外输出的接口，其他文件加载该模块，实际上就是读取<code>module.exports</code>变量。</p> <h3 id="_2-2-exports变量"><a href="#_2-2-exports变量" class="header-anchor">#</a> 2.2 exports变量</h3> <p>为了方便，Node为每个模块提供一个<code>export</code>变量，指向module.exports。这等同与在每个模块头部，有一行这样的命令。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> exports <span class="token operator">=</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
</code></pre></div><p>在对外输出模块接口时，可以想exports对象添加方法。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">area</span> <span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> r <span class="token operator">*</span> r
<span class="token punctuation">}</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">circumference</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">2</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_3-amd规范和commonjs规范的兼容性"><a href="#_3-amd规范和commonjs规范的兼容性" class="header-anchor">#</a> 3.AMD规范和CommonJS规范的兼容性</h2> <p>CommonJSf规范加载模块时同步的，也就是说，只有加载完成，才能执行后面的操作。AMD规范则是非同步加载模块，允许指定回调函数。由于Node.js主要用于服务器编程，模块文件一般都存在于本地硬盘，所以加载起来比较快，不用考虑非同步加载的方式，所以CommonJS规范比较适用。但是，如果是浏览器环境，要从服务端加载模块，这时就必须采用非同步模式，因此浏览器端一般采用AMD规范。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'package/lib'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">lib</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">function</span> <span class="token function">foo</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		lib<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hello world'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">foo</span><span class="token operator">:</span>foo
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>AMD规范允许输出的模块兼容CommonJS规范，这时<code>define</code>方法需要写成下面这样：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> someModule <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;someModule&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> anotherModule <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;anotherModule&quot;</span><span class="token punctuation">)</span>
    
    someModule<span class="token punctuation">.</span><span class="token function">doTehAwesome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    anotherModule<span class="token punctuation">.</span><span class="token function">doMoarAwesome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    exports<span class="token punctuation">.</span><span class="token function-variable function">asplode</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        someModule<span class="token punctuation">.</span>doTehAwesome<span class="token punctuation">;</span>
        anotherModule<span class="token punctuation">.</span><span class="token function">doMoarAwesome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="_4-require命令"><a href="#_4-require命令" class="header-anchor">#</a> 4.require命令</h2> <h3 id="_4-1-基本用法"><a href="#_4-1-基本用法" class="header-anchor">#</a> 4.1 基本用法</h3> <p>Node使用CommonJS模块规范，内置的<code>require</code>命令用于加载模块文件。</p> <p><code>require</code>命令的基本功能是，读入并执行一个JavaScript文件，然后返回该模块的exports对象。如果没有返现指定模块，会报错。</p> <h3 id="_4-2-加载规则"><a href="#_4-2-加载规则" class="header-anchor">#</a> 4.2 加载规则</h3> <p><code>require</code>命令用于加载文件，后缀名默认为<code>.js</code></p> <p>根据参数的不同格式，<code>require</code>命令去不同路径寻找模块文件</p> <ol><li>如果参数字符串以<code>/</code>开头，则表示加载的是一个位于绝对路径的模块文件。</li> <li>如果参数字符串以<code>./</code>开头，则表示加载的是一个位于相对路径的模块文件。</li> <li>如果参数不以<code>'./'</code>或<code>/</code>开头，则表示加载的是一个默认提供的核心模块，（位于Node的系统安装目录种），或者一个位于各级node_modules的目录已安装模块（全局安装或局部安装）。</li> <li>如果字符串不以<code>/</code>或<code>./</code>，而是一个路径，比如<code>require('example-module/path/to/file')</code>,则先找到<code>example-module</code>的位置，然后再以它为参数，找到后续路径。</li> <li>如果指定的模块文件没有发现，Node会尝试为文件名添加<code>.js</code>、<code>.json</code>、<code>.node</code>。</li> <li>如果想得到<code>require</code>命令加载的确切文件名，使用<code>require.resolve()</code>方法。</li></ol> <h3 id="_4-3-目录的加载规则"><a href="#_4-3-目录的加载规则" class="header-anchor">#</a> 4.3 目录的加载规则</h3> <p>通常，我们会把相关的文件会放在一个目录里面，便于组织。这时，最好为该目录设置一个入口文件，让<code>require</code>方法可以通过这个入口文件，加载整个目录。</p> <p>在目录种防止一个<code>package.json</code>文件，并且将入口文件写入<code>main</code>字段。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;some-library&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;main&quot;</span><span class="token operator">:</span><span class="token string">&quot;./lib/some-libary.js&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>require</code>发现参数字符串指向一个目录后。会自动查看该目录的<code>package.json</code>文件，然后加载<code>main</code>字段指定的入口文件。如果<code>package.json</code>文件没有<code>main</code>字段，或者根本就没有<code>package.json</code>文件，则会加载该目录下的<code>index.js</code>文件或<code>index.node</code>文件。</p> <h3 id="_4-4-模块的缓存"><a href="#_4-4-模块的缓存" class="header-anchor">#</a> 4.4 模块的缓存</h3> <p>第一次加载莫格模块时，Node会缓存该模块。以后再加载该模块，就直接从缓存中取出该模块的<code>module.exports</code>属性。</p> <p>所有混村的模块保存再<code>require.cache</code>中，如果想删除该模块的缓存，可以像下面这样写。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 删除指定模块的缓存</span>
<span class="token keyword">delete</span> require<span class="token punctuation">.</span>cache<span class="token punctuation">[</span>moduleName<span class="token punctuation">]</span>

<span class="token comment">// 删除所有模块的缓存</span>
Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>require<span class="token punctuation">.</span>cache<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">delete</span> require<span class="token punctuation">.</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_4-5-环境变量node-path"><a href="#_4-5-环境变量node-path" class="header-anchor">#</a> 4.5 环境变量NODE_PATH</h3> <p>Node执行一个脚本时，会先查看环境变量NODE_PATH。它时一组以冒号分割的绝对路径。在其他位置找不到指定模块时，Node会去这些路径查找。</p> <p>可以将NODE_PATH添加到<code>.bashrc</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token constant">NODE_PATH</span><span class="token operator">=</span><span class="token string">&quot;/usr/local/lib/node&quot;</span>
</code></pre></div><p>所以，如果遇到复杂的相对路径，比如下面这样。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> myModule <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../../../lib/myModule'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>有两种解决方法，一是将该文件加入<code>node_modules</code>目录，二是修改<code>NODE_PATH</code>环境变量，<code>package.json</code>文件可以采用下面的写法。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node_path&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;NODE_PATH=lib node index.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;author&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;license&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ISC&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-6-模块的循环加载"><a href="#_4-6-模块的循环加载" class="header-anchor">#</a> 4.6 模块的循环加载</h3> <p>...</p> <h3 id="_4-7-require-main"><a href="#_4-7-require-main" class="header-anchor">#</a> 4.7 require.main</h3> <p><code>require</code>方法有一个<code>main</code>属性，可以用来判断模块时直接执行，还是被调用执行。</p> <p>直接执行的时候（<code>node module.js</code>），<code>require.main</code>属性指向模块本身。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>require<span class="token punctuation">.</span>main <span class="token operator">===</span> module
</code></pre></div><p>调用执行的时候（通过<code>require</code>加载该脚本执行），上面的表达式返回false</p> <h2 id="_5-模块的加载机制"><a href="#_5-模块的加载机制" class="header-anchor">#</a> 5.模块的加载机制</h2> <p>CommonJS模块加载机制时，输入的是被输出的值的拷贝。也就是说，一旦输出一个值，模块内部的变化就影响不到这个值。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// lib.js</span>
<span class="token keyword">var</span> counter <span class="token operator">=</span> <span class="token number">3</span>
<span class="token keyword">function</span> <span class="token function">inccCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    counter<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
	<span class="token literal-property property">counter</span><span class="token operator">:</span>counter<span class="token punctuation">,</span>
    <span class="token literal-property property">incCounter</span><span class="token operator">:</span>inCounter
<span class="token punctuation">}</span>
</code></pre></div><p>上面代码输出内部变量<code>counter</code>和改变这个变量的内部方法<code>incCounter</code>。</p> <p>然后加载上面的模块。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> counter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./lib'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>counter<span class="token punctuation">;</span>
<span class="token keyword">var</span> incCounter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./lib'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>incCounter
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 3</span>
<span class="token function">incCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 3</span>
</code></pre></div><h3 id="_5-1-require的内部处理流程"><a href="#_5-1-require的内部处理流程" class="header-anchor">#</a> 5.1 require的内部处理流程</h3> <p><code>require</code>命令是CommonJS规范之中，用来加载啊其他模块的命令。它其实不是一个全局命令。而是指向当前模块的<code>module.require</code>命令，而后者又调用Node内部命令<code>Module._load</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Module<span class="token punctuation">.</span><span class="token function-variable function">_load</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> isMain</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 检查 Module._cache，是否缓存之中有指定模块</span>
  <span class="token comment">// 2. 如果缓存之中没有，就创建一个新的Module实例</span>
  <span class="token comment">// 3. 将它保存到缓存</span>
  <span class="token comment">// 4. 使用 module.load() 加载指定的模块文件，</span>
  <span class="token comment">//    读取文件内容之后，使用 module.compile() 执行文件代码</span>
  <span class="token comment">// 5. 如果加载/解析过程报错，就从缓存删除该模块</span>
  <span class="token comment">// 6. 返回该模块的 module.exports</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><code>require</code>函数及其辅助方法主要如下</p> <ul><li><code>require()</code>: 加载外部模块</li> <li><code>require.resolve()</code>：将模块名解析到一个绝对路径</li> <li><code>require.main</code>：指向主模块</li> <li><code>require.cache</code>：指向所有缓存的模块</li> <li><code>require.extensions</code>：根据文件的后缀名，调用不同的执行函数</li></ul></div> <!----></div></div></div> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a138196f.js" defer></script><script src="/assets/js/3.41a850e3.js" defer></script><script src="/assets/js/8.8035cd59.js" defer></script>
  </body>
</html>
